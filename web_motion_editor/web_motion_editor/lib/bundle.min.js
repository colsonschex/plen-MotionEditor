"use strict";var APP_NAME="PLEN2MotionEditor",DiffAngleViewerController,DiffAngleViewerDirective,FrameFactory,ThreeModel,AnimationHelper,FrameEditorDirective,GoogleplusButtonDirective,InstallButtonDirective,ModelLoader,ModelEditorDirective,NewButtonDirective,NextButtonDirective,OpenButtonDirective,AutoResizeDirective,PreviousButtonDirective,ResetButtonDirective,SaveButtonDirective,ScrollableContainerDirective,SyncButtonDirective,TwitterButtonDirective,SERVER_STATE,PLENControlServerService;angular.module(APP_NAME,["ngAnimate","ui.sortable","ui.bootstrap"]);DiffAngleViewerController=function(){function n(n){this.three_model=n;this.name="none";this.diff_angle=0}return n.prototype.onAngleChange=function(){this.name=this.three_model.transform_controls.object.name;this.diff_angle=this.three_model.getDiffAngle(this.three_model.transform_controls.object)/10},n.$inject=["SharedThreeService"],n}();DiffAngleViewerDirective=function(){function n(){}return n.getDDO=function(){return{restrict:"E",controller:DiffAngleViewerController,controllerAs:"$ctrl",scope:{},templateUrl:"./angularjs/components/DiffAngleViewer/view.html",replace:!0,link:function(n){$("html").on("angleChange.toDiffAngleViewer",function(){n.$ctrl.onAngleChange();n.$apply()})}}},n}();angular.module(APP_NAME).directive("diffAngleViewer",[DiffAngleViewerDirective.getDDO]);var EditPropertiesModalController=function(){function n(n,t){var i=this;this.$modalInstance=n;this.motion=t;this.loop_options={use:!1,args:[0,0,255]};this.jump_options={use:!1,args:[0]};_.each(this.motion.codes,function(n){n.func=="loop"&&(i.loop_options.use=!0,i.loop_options.args=n.args);n.func=="jump"&&(i.jump_options.use=!0,i.jump_options.args=n.args)})}return n.prototype.onClickOK=function(){var t,n;try{if(_.isUndefined(this.motion.slot))throw"Slot: Please fill the property. (Required value is between 0 to 89.)";if(this.motion.name.length>20||!/^[\w\s]+$/.test(this.motion.name))throw"Name: Required format is half-width alphanumerics and length is 20 bytes or less.";if(this.loop_options.use){if(_.isUndefined(this.loop_options.args[0])||this.loop_options.args[0]>this.loop_options.args[1]){n=this.loop_options.args[1];throw"Loop function - Begin: Please fill the propertie. (Required value is between 0 to "+n.toString()+".)";}if(_.isUndefined(this.loop_options.args[1])||this.loop_options.args[1]<this.loop_options.args[0]||this.loop_options.args[1]>=this.motion.frames.length){t=this.loop_options.args[0];n=this.motion.frames.length-1;throw"Loop function - End: Please fill the propertie. (Required value is between "+t.toString()+" to "+n.toString()+".)";}if(_.isUndefined(this.loop_options.args[2]))throw"Loop function - Count: Please fill the propertie. (Required value is between 1 to 255.)";}if(this.jump_options.use&&_.isUndefined(this.jump_options.args[0]))throw"Jump function - Slot: Please fill the propertie. (Required value is between 0 to 89.)";}catch(i){alert(i);return}this.motion.codes=[];this.loop_options.use&&this.motion.codes.push(new CodeModel("loop",this.loop_options.args));this.jump_options.use&&this.motion.codes.push(new CodeModel("jump",this.jump_options.args));this.$modalInstance.close()},n.$inject=["$modalInstance","SharedMotionService"],n}(),EditPropertiesButtonController=function(){function n(n,t){var i=this;this.$modal=t;this.disabled=!1;n.$on("ComponentDisabled",function(){i.disabled=!0});n.$on("ComponentEnabled",function(){i.disabled=!1})}return n.prototype.onClick=function(){var n=this.$modal.open({controller:EditPropertiesModalController,controllerAs:"$ctrl",templateUrl:"./angularjs/components/EditPropertiesModal/view.html",backdrop:"static",keyboard:!1})},n.$inject=["$scope","$modal"],n}(),EditPropertiesButtonDirective=function(){function n(){}return n.getDDO=function(){return{restrict:"E",controller:EditPropertiesButtonController,controllerAs:"$ctrl",scope:{},templateUrl:"./angularjs/components/EditPropertiesButton/view.html",replace:!0}},n}();angular.module(APP_NAME).directive("editPropertiesButton",[EditPropertiesButtonDirective.getDDO]);var FacebookButtonController=function(){function n(n){this.$window=n;this.href="http://www.facebook.com/share.php?u=http://plen.jp/playground/motion-editor/"}return n.prototype.onClick=function(){this.$window.open(encodeURI(this.href),"facebook_window","width=650,height=470,menubar=no,toolbar=no,location=no,scrollbars=yes,sizable=no")},n.$inject=["$window"],n}(),CodeModel=function(){function n(n,t){this.func=n;this.args=t}return n}(),OutputDeviceModel=function(){function n(n,t){this.device=n;this.value=t}return n}(),FrameModel=function(){function n(n,t,i,r){this.transition_time_ms=n;this.outputs=t;this.selected=i;this.image_uri=r}return Object.defineProperty(n.prototype,"transition_time_ms",{get:function(){return this._transition_time_ms},set:function(n){_.isString(n)&&(this._transition_time_ms=_.parseInt(n));_.isNumber(n)&&(this._transition_time_ms=n)},enumerable:!0,configurable:!0}),n.prototype.deepCopy=function(n){var t=this;this.transition_time_ms=n.transition_time_ms;this.selected=n.selected;this.image_uri=n.image_uri;this.outputs=[];_.each(n.outputs,function(n){t.outputs.push(new OutputDeviceModel(n.device,n.value))})},n}(),MotionModel=function(){function n(n,t){var i=this;this.$rootScope=n;this.frame_factory=t;this.slot=44;this.name="Empty";this.codes=[];this.frames=[];this.frames.push(this.frame_factory.getFrame());$(window).on("beforeunload",function(){i.$rootScope.$broadcast("FrameSave",i.getSelectedFrameIndex());localStorage.setItem("motion",i.saveJSON())})}return n.prototype.getSelectedFrameIndex=function(){return _.findIndex(this.frames,function(n){return n.selected})},n.prototype.removeFrame=function(t){this.frames.length!==n.MIN_FRAMES?(this.frames[t].selected===!0&&(t+1===this.frames.length?this.selectFrame(t-1):this.selectFrame(t+1)),this.frames.splice(t,1)):this.reset()},n.prototype.addFrame=function(t){var r,u,i;this.frames.length>=n.MAX_FRAMES||(r=_.find(this.frames,function(n){return n.selected}),u=_.findIndex(this.frames,function(n){return n.selected}),this.$rootScope.$broadcast("FrameSave",u),i=this.frame_factory.getFrame(!1),i.deepCopy(r),i.selected=!1,this.frames.splice(t,0,i),this.selectFrame(t,!1))},n.prototype.selectFrame=function(n,t,i){if(t===void 0&&(t=!0),i===void 0&&(i=!0),t){var r=_.findIndex(this.frames,function(n){return n.selected});this.$rootScope.$broadcast("FrameSave",r)}_.each(this.frames,function(n){n.selected=!1});this.frames[n].selected=!0;this.$rootScope.$broadcast("FrameLoad",n);i&&this.$rootScope.$broadcast("FrameLoadFinished")},n.prototype.selectNextFrame=function(){var n=_.findIndex(this.frames,function(n){return n.selected});n+1!==this.frames.length&&this.selectFrame(n+1)},n.prototype.selectPrevFrame=function(){var n=_.findIndex(this.frames,function(n){return n.selected});n!==0&&this.selectFrame(n-1)},n.prototype.reset=function(){this.name="Empty";this.slot=44;this.codes=[];this.frames=[this.frame_factory.getFrame()];this.$rootScope.$broadcast("FrameLoad",0)},n.prototype.loadJSON=function(n,t){var r=this,i;try{if(i=JSON.parse(n),_.isUndefined(i.slot)||!_.isNumber(i.slot))throw"Bad format!";if(_.isUndefined(i.name)||!_.isString(i.name))throw"Bad format!";if(_.isUndefined(i.codes)||!_.isArray(i.codes))throw"Bad format!";if(_.each(i.codes,function(n){if(_.isUndefined(n.func)||!_.isString(n.func))throw"Bad format!";if(_.isUndefined(n.args)||!_.isArray(n.args))throw"Bad format!";else _.each(n.args,function(n){if(!_.isNumber(n))throw"Bad format!";})}),_.isUndefined(i.frames)||!_.isArray(i.frames))throw"Bad format!";else _.each(i.frames,function(n){if(_.isUndefined(n.transition_time_ms)||!_.isNumber(n.transition_time_ms))throw"Bad format!";if(_.isUndefined(n.outputs)||!_.isArray(n.outputs))throw"Bad format!";else _.each(n.outputs,function(n){if(_.isUndefined(n.device)||!_.isString(n.device))throw"Bad format!";if(_.isUndefined(n.value)||!_.isNumber(n.value))throw"Bad format!";})});this.slot=i.slot;this.name=i.name;this.codes=[];_.each(i.codes,function(n){var t=[];_.each(n.args,function(n){t.push(n)});r.codes.push(new CodeModel(n.func,t))});this.frames=[];_.each(i.frames,function(n){var i=[];_.each(n.outputs,function(n){i[t[n.device]]=new OutputDeviceModel(n.device,n.value)});r.frames.push(new FrameModel(n.transition_time_ms,i,!1,""))});this.selectFrame(0,!1)}catch(u){alert("Loading a motion file failed. This file has invalid format.")}},n.prototype.saveJSON=function(){var n={slot:this.slot,name:this.name,codes:this.codes,frames:[]};return _.each(this.frames,function(t){var i={};i.transition_time_ms=t._transition_time_ms;i.outputs=t.outputs;_.each(i.outputs,function(n){n.value=Math.round(n.value)});n.frames.push(i)}),JSON.stringify(n,null,"\t")},n.MIN_FRAMES=1,n.MAX_FRAMES=20,n}(),ImageStoreService=function(){function n(){this._image_canvas=document.createElement("canvas");this._image_canvas.width=150;this._image_canvas.height=150;this._context=this._image_canvas.getContext("2d")}return n.prototype.set=function(n){var r,u,t,i;n.width>n.height?(u=0,t=n.height,i=n.height,r=(n.width-t)/2):(r=0,t=n.width,i=n.width,u=(n.height-i)/2);this._context.drawImage(n,r,u,t,i,0,0,150,150)},n.prototype.get=function(){return this._image_canvas.toDataURL()},n}();angular.module(APP_NAME).service("ImageStoreService",ImageStoreService);FrameFactory=function(){function n(n){this.image_store_service=n}return n.prototype.getFrame=function(n){return n===void 0&&(n=!0),new FrameModel(500,[],n,this.image_store_service.get())},n.$inject=["ImageStoreService"],n}();angular.module(APP_NAME).service("FrameFactory",FrameFactory);angular.module(APP_NAME).service("SharedMotionService",["$rootScope","FrameFactory",MotionModel]);ThreeModel=function(){function n(){this.home_quaternions=[];this.rotation_axes=[];this.not_axes=[]}return n.prototype.init=function(n,t){this.layout=t;var i=this.layout.width(),r=this.layout.height();this.scene=new THREE.Scene;this.camera=new THREE.PerspectiveCamera(75,i/r,.1,5e3);this.camera.up.set(0,1,0);this.camera.position.set(200,200,500);this.grid=new THREE.GridHelper(1e3,100);this.grid.position.set(0,0,0);this.grid.setColors(11721489,16777215);this.scene.add(this.grid);this.light=new THREE.SpotLight(12303291);this.scene.add(this.light);this.renderer=new THREE.WebGLRenderer({preserveDrawingBuffer:!0});this.renderer.setSize(i,r);this.renderer.setClearColor(6732650);this.orbit_controls=new THREE.OrbitControls(this.camera,this.renderer.domElement);this.orbit_controls.zoomSpeed=.3;this.orbit_controls.minDistance=10;this.orbit_controls.maxDistance=2e3;this.transform_controls=new THREE.TransformControls(this.camera,this.renderer.domElement);this.transform_controls.setSpace("local");this.transform_controls.setMode("rotate");this.scene.add(this.transform_controls);n.append(this.renderer.domElement);this.renderer.render(this.scene,this.camera)},n.prototype.reset=function(){var n=this;_.each(this.rotation_axes,function(t,i){t.quaternion.copy(n.home_quaternions[i])})},n.prototype.resize=function(){var n=this.layout.width(),t=this.layout.height();this.camera.aspect=n/t;this.camera.updateProjectionMatrix();this.renderer.setSize(n,t)},n.prototype.animate=function(){var n=this;this.refresh();requestAnimationFrame(function(){n.animate()})},n.prototype.refresh=function(){this.orbit_controls.update();this.transform_controls.update();var i=Math.atan2(this.camera.position.x,this.camera.position.z),n=Math.atan2(Math.sqrt(this.camera.position.x*this.camera.position.x+this.camera.position.z*this.camera.position.z),this.camera.position.y),t=Math.sqrt(3)*1e3;this.light.position.x=t*Math.sin(n)*Math.sin(i);this.light.position.y=t*Math.cos(n);this.light.position.z=t*Math.sin(n)*Math.cos(i);this.renderer.render(this.scene,this.camera)},n.prototype.intersect=function(n,t){var r=this,i=this.renderer.domElement.getBoundingClientRect(),o=(n-i.left)/i.width,s=(t-i.top)/i.height,u=new THREE.Vector3(o*2-1,-(s*2)+1,.5);u.unproject(this.camera);var h=new THREE.Raycaster(this.camera.getWorldPosition(),u.sub(this.camera.getWorldPosition()).normalize()),f=h.intersectObjects(this.not_axes,!0),e=!1;return f[0]&&_.each(this.rotation_axes,function(n){if(n===f[0].object.parent)return r.transform_controls.attach(n),r.orbit_controls.enabled=!1,e=!0,!1;r.orbit_controls.enabled=!0}),e},n.prototype.reverse3DModel=function(){for(var i,r,t=this.rotation_axes.length/2,n=0;n<t;n++)i=this.getDiffAngle(this.rotation_axes[n],n),r=this.getDiffAngle(this.rotation_axes[t+n],t+n),this.setDiffAngle(this.rotation_axes[n],-r,n),this.setDiffAngle(this.rotation_axes[t+n],-i,t+n)},n.prototype.copyRightToLeft=function(){for(var i,t=this.rotation_axes.length/2,n=0;n<t;n++)i=this.getDiffAngle(this.rotation_axes[n],n),this.setDiffAngle(this.rotation_axes[t+n],-i,t+n)},n.prototype.copyLeftToRight=function(){for(var i,t=this.rotation_axes.length/2,n=0;n<t;n++)i=this.getDiffAngle(this.rotation_axes[t+n],t+n),this.setDiffAngle(this.rotation_axes[n],-i,n)},n.prototype.getDiffAngle=function(n,t){var u,r;if(t===void 0&&(t=null),u=null,!_.isUndefined(n)){_.isNull(t)&&(t=_.findIndex(this.rotation_axes,function(t){return t===n}));var e=this.home_quaternions[t].clone(),o=this.rotation_axes[t].quaternion.clone(),f=e.inverse().multiply(o),i=Math.atan2(f.y,f.w);Math.abs(i*2)>Math.PI?(r=2*Math.PI-Math.abs(i*2),i>0&&(r*=-1)):r=i*2;u=Math.round(r*1800/Math.PI)}return u},n.prototype.setDiffAngle=function(n,t,i){var f,r,u;i===void 0&&(i=null);f=t*Math.PI/1800;_.isNull(i)&&(i=_.findIndex(this.rotation_axes,function(t){return t===n}));r=this.home_quaternions[i].clone();u=new THREE.Quaternion;u.setFromAxisAngle(new THREE.Vector3(0,1,0),f);r.multiply(u);this.rotation_axes[i].quaternion.copy(r)},n}();angular.module(APP_NAME).service("SharedThreeService",[ThreeModel]);AnimationHelper=function(){function n(n,t,i){var r=this;this.$rootScope=n;this.$interval=t;this.motion=i;this._outputs_backup=[];this._angle_diffs=[];n.$on("AnimationPlay",function(){r.onAnimationPlay()});n.$on("AnimationStop",function(){r.onAnimationStop()});n.$on("AnimationPrevious",function(){var t=r.motion.getSelectedFrameIndex();if(t!==0)r.onAnimationPlayOnce(t-1);else n.$broadcast("ComponentEnabled")});n.$on("AnimationNext",function(){var t=r.motion.getSelectedFrameIndex();if(t!==r.motion.frames.length-1)r.onAnimationPlayOnce(t+1);else n.$broadcast("ComponentEnabled")})}return n.prototype.onAnimationPlayOnce=function(t,i){var r=this;i===void 0&&(i=null);var f=this.motion.getSelectedFrameIndex(),u=this.motion.frames[f],e=this.motion.frames[t],o=Math.ceil(e.transition_time_ms/(1e3/n.FPS));this._outputs_backup=[];this._angle_diffs=[];_.each(u.outputs,function(n,t){r._outputs_backup.push(n.value);r._angle_diffs.push((e.outputs[t].value-n.value)/o)});this._animation_promise=this.$interval(function(){_.each(r._angle_diffs,function(n,t){u.outputs[t].value+=n});r.$rootScope.$broadcast("FrameLoad",f)},1e3/n.FPS,o);this._animation_promise.catch(function(){i=null});this._animation_promise.finally(function(){_.each(u.outputs,function(n,t){n.value=r._outputs_backup[t]});r.motion.selectFrame(t,!1,!1);i===null?r.$rootScope.$broadcast("ComponentEnabled"):i()})},n.prototype.onAnimationPlay=function(){var n=this,r=!1,u=null,f=null,i=null,e=!1,t;if(_.each(this.motion.codes,function(n){if(n.func==="loop")return r=!0,u=n.args[0],f=n.args[1],i=n.args[2],i===255&&(e=!0),!1}),t=function(){var o=n.motion.getSelectedFrameIndex();if(r&&o===f&&(i>0||e)){i--;n.onAnimationPlayOnce(u,t);return}if(o!==n.motion.frames.length-1)n.onAnimationPlayOnce(o+1,t);else n.$rootScope.$broadcast("ComponentEnabled")},this.motion.getSelectedFrameIndex()!==0)this.onAnimationPlayOnce(0,t);else if(this.motion.frames.length>1)this.onAnimationPlayOnce(1,t);else this.$rootScope.$broadcast("ComponentEnabled")},n.prototype.onAnimationStop=function(){this.$interval.cancel(this._animation_promise)},n.$inject=["$rootScope","$interval","SharedMotionService"],n.FPS=30,n}();angular.module(APP_NAME).service("AnimationHelperService",AnimationHelper);var FrameEditorController=function(){function n(n,t,i){var r=this;this.motion=t;this.animation_helper=i;this.disabled=!1;this.touch_disabled="ontouchend"in document;this.sortable_options={axis:"x",scroll:!1,revert:!0};n.$on("ComponentDisabled",function(){r.disabled=!0});n.$on("ComponentEnabled",function(){r.disabled=!1})}return n.prototype.onClick=function(n){var i,t;n.target.id==="frame_editor"&&(i=_.isUndefined(n.offsetX)?n.pageX-$(n.target).offset().left:n.offsetX,t=Math.floor(i/173),t>this.motion.frames.length?this.motion.addFrame(this.motion.frames.length):this.motion.addFrame(t))},n.$inject=["$scope","SharedMotionService","AnimationHelperService"],n}(),GoogleplusButtonController=function(){function n(n){this.$window=n;this.href="https://plus.google.com/share?url=http://plen.jp/playground/motion-editor/"}return n.prototype.onClick=function(){this.$window.open(encodeURI(this.href),"googleplus_window","width=650,height=470,menubar=no,toolbar=no,location=no,scrollbars=yes,sizable=yes")},n.$inject=["$window"],n}(),InstallButtonController=function(){function n(n,t,i,r){var u=this;this.plen_controll_server_service=n;this.$rootScope=i;this.motion=r;this.disabled=!1;this.installing=!1;t.$on("ComponentDisabled",function(){u.disabled=!0});t.$on("ComponentEnabled",function(){u.disabled=!1});t.$on("InstallFinished",function(){u.installing=!1})}return n.prototype.onClick=function(){var n=this,t;this.plen_controll_server_service.getStatus()===0&&this.plen_controll_server_service.connect(function(){n.onClick()});this.plen_controll_server_service.getStatus()===1&&(t=function(){n.plen_controll_server_service.play(n.motion.slot,function(){n.$rootScope.$broadcast("ComponentDisabled");n.$rootScope.$broadcast("AnimationPlay")})},this.$rootScope.$broadcast("FrameSave",this.motion.getSelectedFrameIndex()),this.plen_controll_server_service.install(JSON.parse(this.motion.saveJSON()),t),this.installing=!0)},n.$inject=["PLENControlServerService","$scope","$rootScope","SharedMotionService"],n}(),ModelEditorPanelController=function(){function n(n,t,i){var r=this;this.$rootScope=t;this.disabled=!1;this._three_model=i;n.$on("ComponentDisabled",function(){r.disabled=!0});n.$on("ComponentEnabled",function(){r.disabled=!1})}return n.prototype.onClick=function(n){switch(n){case 0:this._three_model.reverse3DModel();break;case 1:this._three_model.copyRightToLeft();break;case 2:this._three_model.copyLeftToRight();break;case 3:this._three_model.orbit_controls.reset();break;default:return}this.$rootScope.$broadcast("RefreshThumbnail")},n.$inject=["$scope","$rootScope","SharedThreeService"],n}(),ModelEditorPanelDirective=function(){function n(){}return n.getDDO=function(){return{restrict:"E",controller:ModelEditorPanelController,controllerAs:"$ctrl",scope:{},templateUrl:"./angularjs/components/ModelEditorPanel/view.html",replace:!0}},n}();angular.module(APP_NAME).directive("modelEditorPanel",[ModelEditorPanelDirective.getDDO]);var ModelEditorController=function(){function n(n,t,i,r,u){var f=this;this.model_loader=t;this.three_model=i;this.motion=r;this.image_store_service=u;this.disabled=!1;n.$on("ComponentDisabled",function(){f.disabled=!0});n.$on("ComponentEnabled",function(){f.disabled=!1});n.$on("3DModelLoaded",function(){f.on3DModelLoaded()});n.$on("3DModelReset",function(){f.on3DModelReset()});n.$on("RefreshThumbnail",function(){f.onRefreshThumbnail()});n.$on("FrameSave",function(n,t){f.onFrameSave(t)});n.$on("FrameLoad",function(n,t){f.onFrameLoad(t)})}return n.prototype.on3DModelLoaded=function(){this.setImage();this.three_model.home_quaternions=this.model_loader.home_quaternions;this.three_model.rotation_axes=this.model_loader.rotation_axes;this.three_model.not_axes=this.model_loader.not_axes;var n=localStorage.getItem("motion");_.isNull(n)||this.motion.loadJSON(n,this.model_loader.getAxisMap())},n.prototype.on3DModelReset=function(){this.three_model.reset();this.setImage()},n.prototype.onRefreshThumbnail=function(){this.setImage()},n.prototype.onFrameSave=function(n){var t=this;this.motion.frames[n].outputs=[];_.each(this.three_model.rotation_axes,function(i,r){t.motion.frames[n].outputs.push(new OutputDeviceModel(i.name,t.three_model.getDiffAngle(i,r)))})},n.prototype.onFrameLoad=function(n){var t=this;_.isEmpty(this.motion.frames[n].outputs)?(this.three_model.reset(),this.setImage()):_.each(this.motion.frames[n].outputs,function(n,i){t.three_model.setDiffAngle(null,n.value,i)});_.isEmpty(this.motion.frames[n].image_uri)&&this.setImage()},n.prototype.onFocus=function(n){var t;this.disabled||(_.isUndefined(n.touches)?(t=this.three_model.intersect(n.clientX,n.clientY),t&&this.three_model.transform_controls.$onPointerDown(n)):n.touches.length===1&&(t=this.three_model.intersect(n.clientX,n.clientY),t&&this.three_model.transform_controls.$onPointerDown(n)))},n.prototype.onUnfocus=function(){this.three_model.transform_controls.detach();this.three_model.orbit_controls.enabled=!0;this.setImage()},n.prototype.setImage=function(){var n,t;this.three_model.refresh();n=this.three_model.renderer.domElement;this.image_store_service.set(n);t=_.find(this.motion.frames,function(n){return n.selected});t.image_uri=this.image_store_service.get()},n.$inject=["$scope","ModelLoaderService","SharedThreeService","SharedMotionService","ImageStoreService"],n}(),NewButtonController=function(){function n(n,t,i,r){var u=this;this.$rootScope=n;this.$window=i;this.motion=r;this.disabled=!1;t.$on("ComponentDisabled",function(){u.disabled=!0});t.$on("ComponentEnabled",function(){u.disabled=!1})}return n.prototype.onClick=function(){var n=this.$window.confirm('Are you sure you want to create a new motion?\n\nWorking contents will have destroyed.\nIf your motion has not been saved yet, please click to the "Cancel" button.');n===!0&&(this.motion.reset(),this.$rootScope.$broadcast("3DModelReset"))},n.$inject=["$rootScope","$scope","$window","SharedMotionService"],n}(),NextButtonController=function(){function n(n,t,i){var r=this;this.$rootScope=n;this.motion_model=t;this.disabled=!1;i.$on("ComponentDisabled",function(){r.disabled=!0});i.$on("ComponentEnabled",function(){r.disabled=!1})}return n.prototype.onClick=function(){this.$rootScope.$broadcast("ComponentDisabled");this.$rootScope.$broadcast("FrameSave",this.motion_model.getSelectedFrameIndex());this.$rootScope.$broadcast("AnimationNext")},n.$inject=["$rootScope","SharedMotionService","$scope"],n}(),OpenButtonController=function(){function n(n,t){var i=this;this.motion=t;this.disabled=!1;n.$on("ComponentDisabled",function(){i.disabled=!0});n.$on("ComponentEnabled",function(){i.disabled=!1})}return n.$inject=["$scope","SharedMotionService"],n}(),PlayPauseButtonController=function(){function n(n,t,i,r){var u=this;this.$rootScope=t;this.motion_model=i;this.plen_controll_server_service=r;this.playing=!1;this.title="Play a motion.";n.$on("ComponentDisabled",function(){u.playing=!0;u.title="Pause a motion."});n.$on("ComponentEnabled",function(){u.playing=!1;u.title="Play a motion."})}return n.prototype.onClick=function(){this.playing===!1?(this.$rootScope.$broadcast("ComponentDisabled"),this.$rootScope.$broadcast("FrameSave",this.motion_model.getSelectedFrameIndex()),this.$rootScope.$broadcast("AnimationPlay"),this.plen_controll_server_service.getStatus()===1&&this.plen_controll_server_service.play(this.motion_model.slot)):(this.$rootScope.$broadcast("AnimationStop"),this.plen_controll_server_service.getStatus()===1&&this.plen_controll_server_service.stop())},n.$inject=["$scope","$rootScope","SharedMotionService","PLENControlServerService"],n}(),PlayPauseButtonDirective=function(){function n(){}return n.getDDO=function(){return{restrict:"E",controller:PlayPauseButtonController,controllerAs:"$ctrl",scope:{},templateUrl:"./angularjs/components/PlayPauseButton/view.html",replace:!0}},n}();angular.module(APP_NAME).directive("playPauseButton",[PlayPauseButtonDirective.getDDO]);var PLENControlServerModalController=function(){function n(n){this.$modalInstance=n;this.ip_addr="127.0.0.1:17264"}return n.prototype.connect=function(){/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}:\d{1,5}$/.test(this.ip_addr)?this.$modalInstance.close(this.ip_addr):alert("IP address has invalid format.")},n.prototype.cancel=function(){this.$modalInstance.dismiss()},n.$inject=["$modalInstance"],n}(),PreviousButtonController=function(){function n(n,t,i){var r=this;this.motion_model=t;this.$rootScope=i;this.disabled=!1;n.$on("ComponentDisabled",function(){r.disabled=!0});n.$on("ComponentEnabled",function(){r.disabled=!1})}return n.prototype.onClick=function(){this.$rootScope.$broadcast("ComponentDisabled");this.$rootScope.$broadcast("FrameSave",this.motion_model.getSelectedFrameIndex());this.$rootScope.$broadcast("AnimationPrevious")},n.$inject=["$scope","SharedMotionService","$rootScope"],n}(),ResetButtonController=function(){function n(n,t){var i=this;this.$rootScope=t;this.disabled=!1;n.$on("ComponentDisabled",function(){i.disabled=!0});n.$on("ComponentEnabled",function(){i.disabled=!1})}return n.prototype.onClick=function(){this.$rootScope.$broadcast("3DModelReset")},n.$inject=["$scope","$rootScope"],n}(),SaveButtonController=function(){function n(n,t,i,r){var u=this;this.$rootScope=n;this.$element=i;this.motion=r;this.disabled=!1;t.$on("ComponentDisabled",function(){u.disabled=!0});t.$on("ComponentEnabled",function(){u.disabled=!1});i.on("touchstart",function(){u.onClick()})}return n.prototype.onClick=function(){this.disabled||(this.$rootScope.$broadcast("FrameSave",this.motion.getSelectedFrameIndex()),this.setDownloadLink())},n.prototype.setDownloadLink=function(){var i=this,t=new Blob([this.motion.saveJSON()],{type:"text/plain"}),n;navigator.msSaveBlob?navigator.msSaveBlob(t,this.motion.name+".json"):(n=new FileReader,n.onload=function(){i.$element[0].href=n.result},n.readAsDataURL(t))},n.$inject=["$rootScope","$scope","$element","SharedMotionService"],n}(),ShoppingcartButtonDirective=function(){function n(){}return n.getDDO=function(){return{restrict:"E",scope:{},templateUrl:"./angularjs/components/ShoppingcartButton/view.html",replace:!0}},n}();angular.module(APP_NAME).directive("shoppingcartButton",[ShoppingcartButtonDirective.getDDO]);var SyncButtonController=function(){function n(n,t,i){var r=this;this.$rootScope=t;this.plen_controll_server_service=i;this.disabled=!1;this.syncing=!1;n.$on("ComponentDisabled",function(){r.disabled=!0});n.$on("ComponentEnabled",function(){r.disabled=!1});n.$on("SyncEnd",function(){r.syncing=!1})}return n.prototype.onClick=function(){var n=this,t=function(){n.syncing=!0;n.$rootScope.$broadcast("SyncBegin")};this.syncing?this.$rootScope.$broadcast("SyncEnd"):(this.plen_controll_server_service.getStatus()===0&&this.plen_controll_server_service.connect(t),this.plen_controll_server_service.getStatus()===1&&t())},n.$inject=["$scope","$rootScope","PLENControlServerService"],n}(),TwitterButtonController=function(){function n(n){this.$window=n;this.href="http://twitter.com/share?text=あなた好みにPLENを動かそう！「PLEN - Motion Editor for Web.」は、誰でも簡単にPLENのモーションを作成できるwebアプリです。&url=http://plen.jp/playground/motion-editor/&hashtags=PLEN"}return n.prototype.onClick=function(){this.$window.open(encodeURI(this.href),"tweeter_window","width=650,height=470,menubar=no,toolbar=no,location=no,scrollbars=yes,sizable=yes")},n.$inject=["$window"],n}(),FacebookButtonDirective=function(){function n(){}return n.getDDO=function(){return{restrict:"E",controller:FacebookButtonController,controllerAs:"$ctrl",scope:{},templateUrl:"./angularjs/components/FacebookButton/view.html",replace:!0}},n}();angular.module(APP_NAME).directive("facebookButton",[FacebookButtonDirective.getDDO]);FrameEditorDirective=function(){function n(){}return n.getDDO=function(){return{restrict:"E",controller:FrameEditorController,controllerAs:"$ctrl",scope:{},templateUrl:"./angularjs/components/FrameEditor/view.html"}},n}();angular.module(APP_NAME).directive("frameEditor",[FrameEditorDirective.getDDO]);GoogleplusButtonDirective=function(){function n(){}return n.getDDO=function(){return{restrict:"E",controller:GoogleplusButtonController,controllerAs:"$ctrl",scope:{},templateUrl:"./angularjs/components/GoogleplusButton/view.html",replace:!0}},n}();angular.module(APP_NAME).directive("googleplusButton",[GoogleplusButtonDirective.getDDO]);InstallButtonDirective=function(){function n(){}return n.getDDO=function(){return{restrict:"E",controller:InstallButtonController,controllerAs:"$ctrl",scope:{},templateUrl:"./angularjs/components/InstallButton/view.html",replace:!0}},n}();angular.module(APP_NAME).directive("installButton",[InstallButtonDirective.getDDO]);ModelLoader=function(){function n(n,t){this.$rootScope=n;this.$http=t;this.home_quaternions=[];this.rotation_axes=[];this.not_axes=[]}return n.prototype.addRotationAxis=function(n){var t=this;/roll$/.test(n.name)?(this.rotation_axes.push(n),this.home_quaternions.push(n.quaternion.clone())):/pitch$/.test(n.name)?(this.rotation_axes.push(n),this.home_quaternions.push(n.quaternion.clone())):/yaw$/.test(n.name)?(this.rotation_axes.push(n),this.home_quaternions.push(n.quaternion.clone())):this.not_axes.push(n);n.children.length>0&&_.each(n.children,function(n){t.addRotationAxis(n)})},n.prototype.addObject=function(n){this.scene.add(n);this.addRotationAxis(n)},n.prototype.setScene=function(n){for(this.scene.uuid=n.uuid,this.scene.name=n.name;n.children.length>0;)this.addObject(n.children[0])},n.prototype.getAxisMap=function(){var n={};return _.each(this.rotation_axes,function(t,i){n[t.name]=i}),n},n.prototype.loadJSON=function(){var n=this;this.$http.get("./assets/etc/plen2_3dmodel.min.json").success(function(t){var r=t,u,i;r.metadata.type.toLowerCase()==="object"&&(u=new THREE.ObjectLoader,i=u.parse(r),i instanceof THREE.Scene?n.setScene(i):n.addObject(i),n.$rootScope.$broadcast("3DModelLoaded"))}).error(function(){alert("Loading a 3D model failed. (Please refresh this page.)")})},n}();angular.module(APP_NAME).service("ModelLoaderService",["$rootScope","$http",ModelLoader]);ModelEditorDirective=function(){function n(){}return n.getDDO=function(t,i,r){return{restrict:"E",controller:ModelEditorController,controllerAs:"$model_editor",replace:!0,templateUrl:"./angularjs/components/ModelEditor/view.html",link:{pre:function(t){t.$model_editor.layout={width:function(){return i.innerWidth-n.WIDTH_OFFSET},height:function(){return i.innerHeight-n.HEIGHT_OFFSET},resizeFook:function(){t.$model_editor.three_model.resize()}};t.$model_editor.three_model.init($("#canvas_wrapper"),t.$model_editor.layout);t.$model_editor.three_model.animate();$("#canvas_wrapper canvas").on("mousedown touchstart",function(n){t.$model_editor.onFocus(n)});$("#canvas_wrapper canvas").on("mouseup mouseout touchend touchcancel touchleave",function(){t.$model_editor.onUnfocus();t.$apply()});r.scene=t.$model_editor.three_model.scene;r.loadJSON()}}}},n.WIDTH_OFFSET=265,n.HEIGHT_OFFSET=226,n}();angular.module(APP_NAME).directive("modelEditor",["$rootScope","$window","ModelLoaderService",ModelEditorDirective.getDDO]);NewButtonDirective=function(){function n(){}return n.getDDO=function(){return{restrict:"E",controller:NewButtonController,controllerAs:"$ctrl",scope:{},templateUrl:"./angularjs/components/NewButton/view.html",replace:!0}},n}();angular.module(APP_NAME).directive("newButton",[NewButtonDirective.getDDO]);NextButtonDirective=function(){function n(){}return n.getDDO=function(){return{restrict:"E",controller:NextButtonController,controllerAs:"$ctrl",scope:{},templateUrl:"./angularjs/components/NextButton/view.html",replace:!0}},n}();angular.module(APP_NAME).directive("nextButton",[NextButtonDirective.getDDO]);OpenButtonDirective=function(){function n(){}return n.getDDO=function(n){return{restrict:"E",controller:OpenButtonController,controllerAs:"$ctrl",scope:{},templateUrl:"./angularjs/components/OpenButton/view.html",replace:!0,link:function(t,i){$(i[0].children[1]).on("change",function(i){var r=new FileReader;r.onload=function(i){t.$ctrl.motion.loadJSON(i.target.result,n.getAxisMap());t.$apply()};r.readAsText(i.target.files[0])})}}},n}();angular.module(APP_NAME).directive("openButton",["ModelLoaderService",OpenButtonDirective.getDDO]);AutoResizeDirective=function(){function n(){}return n.getDDO=function(n,t){return{restrict:"A",scope:{layout:"&autoResizeLayout",onload:"&autoResizeOnload"},link:function(i,r){i.onload()===!0&&(r.width(i.layout().width()),r.height(i.layout().height()),i.layout().resizeFook(r));var u=!1;n.addEventListener("resize",function(){u!==!1&&t.cancel(u);u=t(function(){r.width(i.layout().width());r.height(i.layout().height());i.layout().resizeFook(r)},100,!1)})}}},n}();angular.module(APP_NAME).directive("autoResize",["$window","$timeout",AutoResizeDirective.getDDO]);PreviousButtonDirective=function(){function n(){}return n.getDDO=function(){return{restrict:"E",controller:PreviousButtonController,controllerAs:"$ctrl",scope:{},templateUrl:"./angularjs/components/PreviousButton/view.html",replace:!0}},n}();angular.module(APP_NAME).directive("previousButton",[PreviousButtonDirective.getDDO]);ResetButtonDirective=function(){function n(){}return n.getDDO=function(){return{restrict:"E",controller:ResetButtonController,controllerAs:"$ctrl",scope:{},templateUrl:"./angularjs/components/ResetButton/view.html",replace:!0}},n}();angular.module(APP_NAME).directive("resetButton",[ResetButtonDirective.getDDO]);SaveButtonDirective=function(){function n(){}return n.getDDO=function(){return{restrict:"E",controller:SaveButtonController,controllerAs:"$ctrl",scope:{},templateUrl:"./angularjs/components/SaveButton/view.html",replace:!0}},n}();angular.module(APP_NAME).directive("saveButton",[SaveButtonDirective.getDDO]);ScrollableContainerDirective=function(){function n(){}return n.getDDO=function(t){return{restrict:"A",controller:function(){},controllerAs:"$scrollable_container",template:"<div ng-transclude/>",transclude:!0,link:function(i){i.$scrollable_container.layout={width:function(){return t.innerWidth-n.WIDTH_OFFSET},height:function(){return n.HEIGHT},resizeFook:function(){}}}}},n.WIDTH_OFFSET=220,n.HEIGHT=158,n}();angular.module(APP_NAME).directive("scrollableContainer",["$window",ScrollableContainerDirective.getDDO]);SyncButtonDirective=function(){function n(){}return n.getDDO=function(){return{restrict:"E",controller:SyncButtonController,controllerAs:"$ctrl",scope:{},templateUrl:"./angularjs/components/SyncButton/view.html",replace:!0}},n}();angular.module(APP_NAME).directive("syncButton",[SyncButtonDirective.getDDO]);TwitterButtonDirective=function(){function n(){}return n.getDDO=function(){return{restrict:"E",controller:TwitterButtonController,controllerAs:"$ctrl",scope:{},templateUrl:"./angularjs/components/TwitterButton/view.html",replace:!0}},n}();angular.module(APP_NAME).directive("twitterButton",[TwitterButtonDirective.getDDO]),function(n){n[n.DISCONNECTED=0]="DISCONNECTED";n[n.CONNECTED=1]="CONNECTED";n[n.WAITING=2]="WAITING"}(SERVER_STATE||(SERVER_STATE={}));PLENControlServerService=function(){function n(n,t,i,r){var u=this;this.$http=n;this.$modal=t;this.$rootScope=i;this.three_model=r;this._state=0;this._syncing=!1;this.$rootScope.$on("SyncBegin",function(){u.onSyncBegin()});this.$rootScope.$on("SyncEnd",function(){u.onSyncEnd()});this.$rootScope.$on("3DModelReset",function(){u._syncing===!0&&_.each(u.three_model.rotation_axes,function(n){u._socket.send("applyDiff/"+n.name+"/0")})});this.$rootScope.$on("FrameLoadFinished",function(){u._syncing===!0&&_.each(u.three_model.rotation_axes,function(n,t){u._socket.send("applyDiff/"+n.name+"/"+u.three_model.getDiffAngle(n,t).toString())})})}return n.prototype.checkServerVersion=function(){this.$http.get("//"+this._ip_addr+"/connect").success(function(){alert("Your control-server's version is old. Please use latest version.")}).error(function(){alert("The control-server hasn't run.")})},n.prototype.connect=function(n){var t=this,i;n===void 0&&(n=null);this._state===0&&(i=this.$modal.open({controller:PLENControlServerModalController,controllerAs:"$ctrl",templateUrl:"./angularjs/components/PLENControlServerModal/view.html"}),i.result.then(function(i){t._state=2;t._ip_addr=i;t.$http.get("//"+t._ip_addr+"/v2/connect").success(function(i){i.data.result===!0?(t._state=1,_.isNull(n)||n()):(t._state=0,alert("USB connection was disconnected!"),t.$rootScope.$broadcast("SyncEnd"))}).error(function(){t._state=0;t.checkServerVersion()})}))},n.prototype.disconnect=function(n){var t=this;n===void 0&&(n=null);this._state===1&&(this._state=2,this.$http.get("//"+this._ip_addr+"/v2/disconnect").success(function(i){i.data.result===!0&&(_.isNull(n)||n());t._state=0;alert("USB connection was disconnected!");t.$rootScope.$broadcast("SyncEnd")}).error(function(){t._state=1}))},n.prototype.install=function(n,t){var i=this;t===void 0&&(t=null);this._state===1&&(this._state=2,this.$http.put("//"+this._ip_addr+"/v2/motions/"+n.slot.toString(),n).success(function(n){i._state=1;n.data.result===!0?_.isNull(t)||t():(i._state=0,alert("USB connection was disconnected!"),i.$rootScope.$broadcast("SyncEnd"))}).error(function(){i._state=0}).finally(function(){i.$rootScope.$broadcast("InstallFinished")}))},n.prototype.play=function(n,t){var i=this;t===void 0&&(t=null);this._state===1&&(this._state=2,this.$http.get("//"+this._ip_addr+"/v2/motions/"+n.toString()+"/play").success(function(n){i._state=1;n.data.result===!0?_.isNull(t)||t():(i._state=0,alert("USB connection was disconnected!"),i.$rootScope.$broadcast("SyncEnd"))}).error(function(){i._state=0}))},n.prototype.stop=function(n){var t=this;n===void 0&&(n=null);this._state===1&&(this._state=2,this.$http.get("//"+this._ip_addr+"/v2/motions/stop").success(function(i){t._state=1;i.data.result===!0?_.isNull(n)||n():(t._state=0,alert("USB connection was disconnected!"),t.$rootScope.$broadcast("SyncEnd"))}).error(function(){t._state=0}))},n.prototype.getStatus=function(){return this._state},n.prototype.onSyncBegin=function(){var n=this;this._socket=new WebSocket("ws://"+this._ip_addr+"/v2/cmdstream");this._socket.onopen=function(){if(n._socket.readyState===WebSocket.OPEN){n._state=1;$("html").on("angleChange.toPLENControlServerService",function(){if(n._state===1){var t=n.three_model.transform_controls.object.name,i=n.three_model.getDiffAngle(n.three_model.transform_controls.object);n._socket.send("applyDiff/"+t+"/"+i.toString());n._state=2}})}};this._socket.onmessage=function(t){t.data=="False"?n._state===2&&(n._state=0,alert("USB connection was disconnected!"),n.$rootScope.$broadcast("SyncEnd")):n._state=1};this._socket.onerror=function(){n._state=0;alert("USB connection was disconnected!");n.$rootScope.$broadcast("SyncEnd")};this._syncing=!0},n.prototype.onSyncEnd=function(){this._syncing=!1;$("html").off("angleChange.toPLENControlServerService")},n.$inject=["$http","$modal","$rootScope","SharedThreeService"],n}();angular.module(APP_NAME).service("PLENControlServerService",PLENControlServerService);
//# sourceMappingURL=bundle.min.js.map
